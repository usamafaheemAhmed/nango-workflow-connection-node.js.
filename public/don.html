<style>
  .mainDiv {
    font-family: "Lato", sans-serif;
    background-color: #f8f9fa;
    margin: 0;
    padding: 10px 0 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
  }

  h2 {
    margin: 25px 0 20px;
    font-size: 24px;
    font-weight: 600;
    color: #333;
  }

  #Nango_tools {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 18px;
    width: 100%;
    max-width: 700px;
    padding: 0 20px;
    justify-items: center;
  }

  .tool-card {
    background: #fff;
    border-radius: 10px;
    padding: 15px 10px 20px;
    text-align: center;
    width: 190px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .tool-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
  }

  .tool-card img {
    width: 45px;
    height: 45px;
    object-fit: contain;
    margin-bottom: 10px;
  }

  .tool-card h3 {
    font-size: 15px;
    font-weight: 600;
    color: #333;
    margin: 8px 0 12px;
    line-height: 1.3;
    text-align: center;
  }

  .tool-btn {
    background-color: #e16f56;
    color: white;
    border: none;
    width: 100%;
    padding: 8px 0;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s ease, transform 0.1s ease;
  }

  .tool-btn:hover {
    background-color: #28a745;
    transform: scale(1.03);
  }

  /* Optional subtle animation for cards on load */
  .tool-card {
    opacity: 0;
    transform: translateY(10px);
    animation: fadeInUp 0.3s forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<div class="mainDiv">
  <h2>Available Tools</h2>
  <div id="Nango_tools"></div>
</div>
<script>
  (() => {
    // ‚úÖ Prevent redeclaration if script runs again
    if (window.NangoToolsInitialized) return;
    window.NangoToolsInitialized = true;

    // --- Define global variables only once ---
    window.memberId = window.memberId || null;
    window.memberEmailCustom = window.memberEmailCustom || null;
    window.memberNameCustom = window.memberNameCustom || null;

    async function getMemberInfo() {
      console.log("üöÄ getMemberInfo() called...");

      // üß© Ensure MemberSpace is ready
      if (
        !window.MemberSpace ||
        typeof window.MemberSpace.getMemberInfo !== "function"
      ) {
        console.warn(
          "‚ö†Ô∏è MemberSpace not loaded or getMemberInfo() not available yet"
        );
        return null;
      }

      try {
        console.log("üì° Calling window.MemberSpace.getMemberInfo()...");
        const info = await window.MemberSpace.getMemberInfo();
        console.log("‚úÖ Raw MemberSpace response:", info);

        // üß† Handle structure with { isLoggedIn, memberInfo }
        const member = info?.memberInfo || info;

        if (!member || !member.email) {
          console.warn("‚ö†Ô∏è Member info missing or incomplete:", member);
          return null;
        }

        // ‚úÖ Assign to globals
        window.memberId = member.id;
        window.memberEmailCustom = member.email;
        window.memberNameCustom = `${member.firstName || ""} ${
          member.lastName || ""
        }`.trim();

        console.log("üéØ Extracted member data:", {
          id: window.memberId,
          email: window.memberEmailCustom,
          name: window.memberNameCustom,
        });

        // Return object for use in Connect flow
        return {
          memberId: window.memberId,
          memberEmailCustom: window.memberEmailCustom,
          memberNameCustom: window.memberNameCustom,
        };
      } catch (err) {
        console.error("‚ùå Error fetching MemberSpace info:", err);
        return null;
      }
    }

    async function loadTools() {
      console.log(
        window.memberId,
        window.MemberSpace,
        await window.MemberSpace.getMemberInfo()
      );
      const res = await fetch(
        "https://leadchaser-nango-5lptm.ondigitalocean.app/tools"
      );
      const tools = await res.json();
      const container = document.getElementById("Nango_tools");
      container.innerHTML = ""; // üßπ clear before re-render

      tools.forEach((tool) => {
        const card = document.createElement("div");
        card.className = "tool-card";

        const logo = document.createElement("img");
        logo.src = tool.logo;
        logo.alt = tool.name;

        const title = document.createElement("h3");
        title.textContent = tool.name;

        const btn = document.createElement("button");
        btn.className = "tool-btn";
        btn.textContent = `Connect`;
        btn.onclick = async () => {
          console.log("üü† Connect button clicked for tool:", tool.name);

          try {
            // 1Ô∏è‚É£ Get Member Info
            console.log("‚è≥ Fetching MemberSpace user info...");
            const user = await getMemberInfo();
            console.log("‚úÖ Member info received:", user);

            if (!user || !user.memberId) {
              console.warn("‚ö†Ô∏è Member not identified yet.");
              alert(
                "Member not identified yet. Please log in to MemberSpace first."
              );
              return;
            }

            // 2Ô∏è‚É£ Create Nango session
            console.log("üì° Sending request to backend /create-session...");
            const payload = {
              clientId: user.memberId,
              clientName: user.memberNameCustom,
              memberEmail: user.memberEmailCustom,
              toolKey: tool.key,
            };
            console.log("üßæ Payload being sent:", payload);

            const res = await fetch(
              "https://leadchaser-nango-5lptm.ondigitalocean.app/create-session",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );

            console.log("üì• Raw response object:", res);

            if (!res.ok) {
              const errorText = await res.text();
              console.error(
                "‚ùå Backend returned error:",
                res.status,
                errorText
              );
              alert(`Server error: ${res.status}`);
              return;
            }

            // 3Ô∏è‚É£ Parse JSON response
            const data = await res.json();
            console.log("üì¶ Parsed backend response:", data);

            // Handle multiple possible structures
            const sessionToken = data?.data?.token || data?.token;
            console.log("üîë Extracted session token:", sessionToken);

            if (!sessionToken) {
              console.warn("‚ö†Ô∏è No session token found in response!");
              alert("Could not create session (missing token).");
              return;
            }

            // 4Ô∏è‚É£ Redirect user
            const nangoUrl = `https://connect.nango.dev?session_token=${sessionToken}`;
            console.log("üåç Redirecting to Nango Connect:", nangoUrl);

            // Some modals block navigation, so we use window.open for safety
            window.open(nangoUrl, "_blank");
            console.log(
              "‚úÖ Redirect executed successfully (opened in new tab)."
            );
          } catch (err) {
            console.error("üî• Unexpected error during connect flow:", err);
            alert("An unexpected error occurred. Check console for details.");
          }
        };

        card.appendChild(logo);
        card.appendChild(title);
        card.appendChild(btn);
        container.appendChild(card);
      });
    }

    loadTools();
  })();
</script>
