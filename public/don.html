<style>

  .mainDiv {
    font-family: "Lato", sans-serif;
    background: transparent;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
  }
  h2 {
    margin: 15px 0 20px;
    font-size: 22px;
    font-weight: 700;
    color: #111;
    text-align: center;
  }
  #Nango_tools {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(85px, 1fr));
    gap: 16px;
    width: 100%;
    max-width: 420px;
    padding: 0 5px 20px;
    justify-items: center;
    align-items: center;
  }
  .tool-card {
    background: #fff;
    border: 1.5px solid #e2e2e2;
    border-radius: 12px;
    width: 90px;
    height: 90px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: #999;
  }
  .tool-card img {
    width: 30px;
    height: 30px;
    object-fit: contain;
    filter: grayscale(1);
    opacity: 0.6;
    transition: all 0.25s ease;
  }
  .tool-card span {
    font-size: 11.5px;
    font-weight: 600;
    color: #777;
    margin-top: 6px;
    line-height: 1.25;
    transition: color 0.25s ease;
    width: 90%;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .tool-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 10px rgba(0, 123, 255, 0.15);
    transform: translateY(-3px);
    color: #222;
  }
  .tool-card:hover img {
    filter: grayscale(0);
    opacity: 1;
    transform: scale(1.08);
  }
  .tool-card:hover span {
    color: #007bff;
  }
  /* Entrance animation */
  .tool-card {
    opacity: 0;
    transform: translateY(6px);
    animation: fadeInUp 0.3s forwards;
  }
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  /* Responsive fine-tuning for modal */
  @media (max-width: 480px) {
    #Nango_tools {
      grid-template-columns: repeat(auto-fit, minmax(75px, 1fr));
      gap: 12px;
      max-width: 350px;
    }
    .tool-card {
      width: 80px;
      height: 80px;
      border-radius: 10px;
    }
    .tool-card img {
      width: 26px;
      height: 26px;
    }
    .tool-card h3 {
      font-size: 10.5px;
    }
  }
</style>
<div class="mainDiv">
  <h2>Available Tools</h2>
  <div id="Nango_tools"></div>
</div>
<script>
  (() => {
    // âœ… Prevent redeclaration if script runs again
    if (window.NangoToolsInitialized) return;
    window.NangoToolsInitialized = true;
    // --- Define global variables only once ---
    window.memberId = window.memberId || null;
    window.memberEmailCustom = window.memberEmailCustom || null;
    window.memberNameCustom = window.memberNameCustom || null;
    async function getMemberInfo() {
      console.log("ðŸš€ getMemberInfo() called...");
      // ðŸ§© Ensure MemberSpace is ready
      if (
        !window.MemberSpace ||
        typeof window.MemberSpace.getMemberInfo !== "function"
      ) {
        console.warn(
          "âš ï¸ MemberSpace not loaded or getMemberInfo() not available yet"
        );
        return null;
      }
      try {
        console.log("ðŸ“¡ Calling window.MemberSpace.getMemberInfo()...");
        const info = await window.MemberSpace.getMemberInfo();
        console.log("âœ… Raw MemberSpace response:", info);
        // ðŸ§  Handle structure with { isLoggedIn, memberInfo }
        const member = info?.memberInfo || info;
        if (!member || !member.email) {
          console.warn("âš ï¸ Member info missing or incomplete:", member);
          return null;
        }
        // âœ… Assign to globals
        window.memberId = member.id;
        window.memberEmailCustom = member.email;
        window.memberNameCustom = `${member.firstName || ""} ${
          member.lastName || ""
        }`.trim();
        console.log("ðŸŽ¯ Extracted member data:", {
          id: window.memberId,
          email: window.memberEmailCustom,
          name: window.memberNameCustom,
        });
        // Return object for use in Connect flow
        return {
          memberId: window.memberId,
          memberEmailCustom: window.memberEmailCustom,
          memberNameCustom: window.memberNameCustom,
        };
      } catch (err) {
        console.error("âŒ Error fetching MemberSpace info:", err);
        return null;
      }
    }
    async function loadTools() {
      const res = await fetch(
        "https://leadchaser-nango-5lptm.ondigitalocean.app/tools"
      );
      const tools = await res.json();
      const container = document.getElementById("Nango_tools");
      container.innerHTML = ""; // ðŸ§¹ clear before re-render
      tools.forEach((tool) => {
        const card = document.createElement("div");
        card.className = "tool-card";
        const logo = document.createElement("img");
        logo.src = tool.logo;
        logo.alt = tool.name;
        const title = document.createElement("span");
        title.textContent = tool.name;
        card.appendChild(logo);
        card.appendChild(title);
        // ðŸ‘‡ On click, same connect logic
        card.onclick = async () => {
          console.log("ðŸŸ  Connect button clicked for tool:", tool.name);
          try {
            const user = await getMemberInfo();
            if (!user || !user.memberId) {
              alert("Please log in to MemberSpace first.");
              return;
            }
            const payload = {
              clientId: user.memberId,
              clientName: user.memberNameCustom,
              memberEmail: user.memberEmailCustom,
              toolKey: tool.key,
            };
            const res = await fetch(
              "https://leadchaser-nango-5lptm.ondigitalocean.app/create-session",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            const sessionToken = data?.data?.token || data?.token;
            if (!sessionToken) throw new Error("Missing token");
            window.open(
              `https://connect.nango.dev?session_token=${sessionToken}`,
              "_blank"
            );
          } catch (err) {
            console.error("ðŸ”¥ Error:", err);
            alert("An unexpected error occurred. Check console for details.");
          }
        };
        container.appendChild(card);
      });
    }
    loadTools();
  })();
</script>
